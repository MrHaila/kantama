# Kantama

_/ˈkɑntɑmɑ/ — n. how far you can get_

An interactive map of temporal distances between places in Finland's greater capital region (Helsinki, Espoo, Vantaa, Kauniainen) using public transit.

Deployed to [kantama.haila.fi](https://kantama.haila.fi).

TBD screenshot or gif here.

## What & How?

To show a map of _how long it would take to get from anywhere to anywhere_, I have picked reference locations in every sub-district and pre-calculated routes between them. On the website, you can select any sub-district to see a heat-map of its connectivity and hover over other sub-districts to see the exact connection.

I calculated the map three times: morning, evening, and midnight to see how the results vary at different times. That's about 200 000 routes!

All of this is based on open data and free tools. Have fun exploring!

### Dirty Details

Making this map was an interesting puzzle. Here are the main moving parts:

- Background map: sourced from the open dataset of [Maanmittauslaitos](https://www.maanmittauslaitos.fi/en/). The data is available as ESRI shapefiles. The source data is quite detailed, so I picked a few interesting layers, culled the data to the map boundaries I wanted, simplified the geometry, and exported as SVG layers.
- Transit data: HSL publishes their [routing data](https://www.hsl.fi/en/hsl/open-data) and is involved in the [OpenTripPlanner](https://www.opentripplanner.org/) project to consume the data. I ran this locally to avoid bombarding the public API hosted by [Digitransit](https://digitransit.fi/en/).
- Zoning info: each county has their own public data set (and format and conventions, sigh) for district boundaries. I had Claude Code build adapters for each of them and culled the data to the map boundaries I wanted. As a bonus round, I locally refined the zoning data to not overlap with water by using the background map water layer.
- Reference points: I find the [poles of inaccessibility](https://en.wikipedia.org/wiki/Pole_of_inaccessibility) for each zone as a starting point and use reverse geocoding to find the nearest street address. [Digitransit](https://digitransit.fi/en/) hosts an [open API](https://digitransit.fi/en/developers/apis/3-geocoding-api/address-lookup/) for this and I figured it's not forth the hassle to self-host.
- Routes: I use the [OpenTripPlanner](https://www.opentripplanner.org/) to calculate routes from every reference point to every other reference point (sample of 3 and pick the fastest one) for three starting times: 08:30, 17:00, and 24:00. the routes get stored files on disk. Since this creates a lot of information, I simplify the generated map data for 50% file size savings.
- Heatmaps and transit overlays: I pre-calculate aggregate stats from the route data to avoid loading all of the routes at once in the browser. Manual fiddling around to find interesting dimensions to show.

All of the above is orchestrated by a CLI tool in the /varikko folder. The intent is to be able to iterate on each step individually, have high test coverage and re-run them as needed.

Actual website is a fairly simple Vue.js app in /opas that lazy-loads data and handles layered rendering, interaction and animations. Lot's of implementation details but nothing out of the ordinary.

Practically all of the code is written by LLMs. Maybe don't directly copy anything?

## Development

The project has been split into three sub-projects:

- `otp/`: OpenTripPlanner instance for public transit routing.
- `varikko/`: CLI for pre-computing all the map and transit data offline.
- `opas/`: Web frontend for visualizing the data generated by Varikko.

You'll need Node.js, PNPM, and Docker to run the projects locally.

### Local Setup

This is a full rundown of setting up the project from scratch. It involves downloading and generating a lot of data that I did not want to commit to Git.

#### OpenTripPlanner

OTP needs to be running to calculate routes.

1. Run `pnpm run fetch` in the `otp/` directory to download the latest HSL graph data.
1. Run `docker compose up` in the `otp/` directory to start OTP.

#### Varikko

Varikko helps run the data pipeline in steps.

1. Run `pnpm dev map` in the `varikko/` directory to generate map data. This will be used by zone fetching for refinement.
1. Run `pnpm dev fetch` in the `varikko/` directory to fetch & refine zoning data.
1. Run `pnpm dev geocode` in the `varikko/` directory to find good reference points for each zone. This will complain if you don't have a free API key from [Digitransit](https://digitransit.fi/en/).
1. Run `pnpm dev routes` in the `varikko/` directory to calculate routes between all reference points for all zones. This takes ~4 hours on my M1 Mac.
1. Run `pnpm dev simplify-routes` in the `varikko/` directory to optimize route data for file size. 
1. Run `pnpm dev time-buckets` in the `varikko/` directory to calculate aggregate data for heat maps.
1. Run `pnpm dev reachability` in the `varikko/` directory to calculate reachability data for heat maps.
1. Run `pnpm dev transit-layer` in the `varikko/` directory to generate a combined transit layer for fun visualization.

#### Opas

Opas will load data generated by Varikko to actually show the thing. Static files only; no Node.js server needed.

1. Run `pnpm dev` in the `opas/` directory to start the development server.

### Deployment

1. Run `pnpm build` in the `opas/` directory to build the production version.
1. Upload to wherever you host your static files. Payload is in `opas/dist`.

I host this in Netlify. `netlify deploy --prod` will build and deploy the production version.

## License

CC BY 4.0 for all my original work.

Source data belongs to their respective maintainers. The map data is licensed by Maanmittauslaitos with CC BY 4.0.